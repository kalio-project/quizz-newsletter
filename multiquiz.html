<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Quiz - ActuQuiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        .option-btn { transition: all 0.2s; border: 2px solid #f1f5f9; }
        .option-btn.correct { border-color: #22c55e; background-color: #f0fdf4; color: #166534; }
        .option-btn.wrong { border-color: #ef4444; background-color: #fef2f2; color: #991b1b; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #2563eb; cursor: pointer; border: 4px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4 md:p-10">

    <nav class="max-w-2xl mx-auto mb-8">
        <a href="index.html" class="text-blue-600 font-black uppercase text-[10px] tracking-widest">← Retour à l'accueil</a>
    </nav>

    <main class="max-w-2xl mx-auto">
        <div id="setup-screen" class="bg-white rounded-[3rem] p-8 md:p-12 shadow-xl border border-slate-100">
            <h1 class="text-4xl font-black text-slate-900 italic uppercase tracking-tighter mb-2">Super Quiz.</h1>
            <p class="text-slate-400 font-medium mb-10 text-sm">Créez votre session personnalisée parmi toutes les actus.</p>

            <div class="space-y-10">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">Choisir un thème</label>
                    <div id="theme-select" class="flex flex-wrap gap-2">
                        <button onclick="selectTheme('TOUT')" class="theme-tag px-4 py-2 rounded-xl border-2 border-slate-100 text-xs font-bold uppercase transition-all bg-white" data-theme="TOUT">TOUT</button>
                        </div>
                </div>

                <div>
                    <div class="flex justify-between mb-4">
                        <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Nombre de questions</label>
                        <span id="q-val" class="text-blue-600 font-black text-sm">10</span>
                    </div>
                    <input type="range" id="q-range" min="5" max="50" value="10" oninput="document.getElementById('q-val').innerText = this.value">
                </div>

                <button onclick="launchMulti()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-blue-200 hover:bg-slate-900 transition-all">
                    Démarrer la session
                </button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="bg-white rounded-[3rem] p-6 md:p-10 shadow-xl border border-slate-100">
                <div class="flex justify-between items-center mb-8">
                    <span id="game-cat" class="text-[10px] font-black px-2 py-1 border border-blue-600 text-blue-600 rounded uppercase tracking-widest">INFO</span>
                    <span id="game-counter" class="text-slate-300 font-bold text-[10px] tracking-widest uppercase">01 / 10</span>
                </div>

                <div id="q-content">
                    <h2 id="q-text" class="text-xl md:text-2xl font-black text-slate-900 mb-8 leading-tight"></h2>
                    <div id="options-grid" class="space-y-3"></div>
                    
                    <div id="expl-zone" class="hidden mt-8">
                        <div class="p-6 bg-blue-50 rounded-2xl border-2 border-blue-100 text-slate-700 text-sm mb-6">
                            <p id="expl-text"></p>
                        </div>
                        <button onclick="nextQ()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest">Suivant →</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let allQuizzes = [];
        let selection = [];
        let currentIdx = 0;
        let score = 0;
        let activeTheme = "TOUT";

        async function init() {
            try {
                const res = await fetch('manifest.json');
                allQuizzes = await res.json();
                
                // 1. Générer les tags de thèmes
                const themes = [...new Set(allQuizzes.map(q => q.theme))].filter(t => t);
                const container = document.getElementById('theme-select');
                themes.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = "theme-tag px-4 py-2 rounded-xl border-2 border-slate-100 text-xs font-bold uppercase transition-all bg-white";
                    btn.innerText = t;
                    btn.dataset.theme = t;
                    btn.onclick = () => selectTheme(t);
                    container.appendChild(btn);
                });

                // 2. Vérifier si un thème est passé en URL (clic depuis index)
                const urlParams = new URLSearchParams(window.location.search);
                const themeParam = urlParams.get('theme');
                if(themeParam) selectTheme(themeParam);
                else selectTheme('TOUT');

            } catch (e) { console.error("Erreur init", e); }
        }

        function selectTheme(t) {
            activeTheme = t;
            document.querySelectorAll('.theme-tag').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50');
                if(btn.dataset.theme === t) btn.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
            });
        }

        async function launchMulti() {
            const count = parseInt(document.getElementById('q-range').value);
            let pool = [];

            // Filtrer les quiz par thème
            const filteredQuizzes = activeTheme === "TOUT" 
                ? allQuizzes 
                : allQuizzes.filter(q => q.theme === activeTheme);

            // Charger toutes les questions
            for (const quiz of filteredQuizzes) {
                try {
                    const res = await fetch(quiz.file);
                    const data = await res.json();
                    pool.push(...data.questions);
                } catch(e) {}
            }

            // Mélanger et limiter
            selection = pool.sort(() => Math.random() - 0.5).slice(0, count);
            
            if(selection.length === 0) return alert("Pas de questions trouvées.");

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            renderQ();
        }

        function renderQ() {
            const q = selection[currentIdx];
            document.getElementById('game-counter').innerText = `${currentIdx + 1} / ${selection.length}`;
            document.getElementById('game-cat').innerText = q.categorie || activeTheme;
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('expl-zone').classList.add('hidden');
            
            const grid = document.getElementById('options-grid');
            grid.innerHTML = "";

            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full p-5 rounded-2xl text-left font-bold text-slate-700 bg-slate-50";
                btn.innerText = opt;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                    document.getElementById('expl-text').innerHTML = `<strong>${i === q.correct ? '✅ Bravo' : '❌ Incorrect'}</strong><br>${q.explication}`;
                    document.getElementById('expl-zone').classList.remove('hidden');
                    
                    if(i === q.correct) {
                        btn.classList.add('correct');
                        score++;
                    } else {
                        btn.classList.add('wrong');
                        grid.querySelectorAll('button')[q.correct].classList.add('correct');
                    }
                };
                grid.appendChild(btn);
            });
        }

        function nextQ() {
            currentIdx++;
            if(currentIdx < selection.length) renderQ();
            else {
                document.getElementById('game-screen').innerHTML = `
                    <div class="text-center p-10">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Score Final</h2>
                        <div class="text-8xl font-black text-blue-600 mb-10">${score} / ${selection.length}</div>
                        <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest">Nouveau défi</button>
                    </div>`;
            }
        }

        init();
    </script>
</body>
</html>
